#' @name mapGenes
#'
#' @inheritParams params
#' @param strict `boolean`. Require all genes to match. Recommended by default.
#'   If set `FALSE`, instead will return a warning to the user, and subset the
#'   genes vector to only include matches.
#'
#' @examples
#' data(rse)
#' object <- rse
#' print(object)
#'
#' rownames <- head(rownames(object))
#' print(rownames)
#'
#' geneIDs <- object %>%
#'     SummarizedExperiment::rowData(.) %>%
#'     .[["geneID"]] %>%
#'     head()
#' print(geneIDs)
#'
#' geneNames <- object %>%
#'     SummarizedExperiment::rowData(.) %>%
#'     .[["geneName"]] %>%
#'     head()
#' print(geneNames)
#'
#' ## Row names.
#' mapGenesToRownames(object, genes = rownames)
#' mapGenesToRownames(object, genes = geneIDs)
#' mapGenesToRownames(object, genes = geneNames)
#'
#' ## Gene identifiers.
#' mapGenesToIDs(object, genes = rownames)
#' mapGenesToIDs(object, genes = geneIDs)
#' mapGenesToIDs(object, genes = geneNames)
#'
#' ## Gene names (symbols).
#' mapGenesToSymbols(object, genes = rownames)
#' mapGenesToSymbols(object, genes = geneIDs)
#' mapGenesToSymbols(object, genes = geneNames)
NULL



# Internal =====================================================================
.mapGenes <- function(object, genes, strict = TRUE) {
    assert_is_all_of(object, "Gene2Symbol")
    validObject(object)
    assert_is_character(genes)
    assert_is_non_empty(genes)
    assert_is_a_bool(strict)

    # Prepare the match table.
    if (any(genes %in% rownames(object))) {
        table <- rownames(object)
    } else if (any(genes %in% object[["geneName"]])) {
        assertAllAreUniqueGeneNames(object, genes)
        table <- object[["geneName"]]
    } else if (any(genes %in% object[["geneID"]])) {
        table <- object[["geneID"]]
    } else {
        stop(paste(
            "All genes failed to map:", toString(head(genes))
        ), call. = FALSE)
    }

    # Match the user input `genes` vector to the table.
    match <- match(x = genes, table = table)
    names(match) <- genes

    # Stop or warn if there are unmapped genes.
    if (isTRUE(strict)) {
        fun <- stop
    } else {
        fun <- warning
    }
    unmapped <- which(is.na(match))
    if (has_length(unmapped)) {
        fun(paste(
            "Some genes failed to map:", toString(genes[unmapped])
        ), call. = FALSE)
    }

    # Return the identifiers that map to rownames.
    mapped <- na.omit(match)
    assert_is_non_empty(mapped)
    mapped
}



# mapGenesToRownames ===========================================================
mapGenesToRownames.Gene2Symbol <-  # nolint
    function(object, genes, strict = TRUE) {
        mapped <- do.call(
            what = .mapGenes,
            args = list(
                object = object,
                genes = genes,
                strict = strict
            )
        )
        return <- rownames(object[mapped, , drop = FALSE])
        return <- as.character(return)
        names(return) <- names(mapped)
        return
    }



#' @rdname mapGenes
#' @export
setMethod(
    f = "mapGenesToRownames",
    signature = signature("Gene2Symbol"),
    definition = mapGenesToRownames.Gene2Symbol
)



mapGenesToRownames.SummarizedExperiment <-  # nolint
    function(object, genes, strict = TRUE) {
        validObject(object)
        suppressMessages(
            g2s <- Gene2Symbol(object)
        )
        assert_are_identical(rownames(g2s), rownames(object))
        do.call(
            what = mapGenesToRownames,
            args = list(
                object = g2s,
                genes = genes,
                strict = strict
            )
        )
    }



#' @rdname mapGenes
#' @export
setMethod(
    f = "mapGenesToRownames",
    signature = signature("SummarizedExperiment"),
    definition = mapGenesToRownames.SummarizedExperiment
)



# mapGenesToIDs ================================================================
mapGenesToIDs.Gene2Symbol <-  # nolint
    function(object, genes, strict = TRUE) {
        mapped <- do.call(
            what = .mapGenes,
            args = list(
                object = object,
                genes = genes,
                strict = strict
            )
        )
        return <- object[mapped, , drop = FALSE]
        return <- return[["geneID"]]
        return <- as.character(return)
        names(return) <- names(mapped)
        return
    }



#' @rdname mapGenes
#' @export
setMethod(
    f = "mapGenesToIDs",
    signature = signature("Gene2Symbol"),
    definition = mapGenesToIDs.Gene2Symbol
)



mapGenesToIDs.SummarizedExperiment <-  # nolint
    function(object, genes, strict = TRUE) {
        validObject(object)
        suppressMessages(
            g2s <- Gene2Symbol(object)
        )
        assert_are_identical(rownames(g2s), rownames(object))
        do.call(
            what = mapGenesToIDs,
            args = list(
                object = g2s,
                genes = genes,
                strict = strict
            )
        )
    }



#' @rdname mapGenes
#' @export
setMethod(
    f = "mapGenesToIDs",
    signature = signature("SummarizedExperiment"),
    definition = mapGenesToIDs.SummarizedExperiment
)



# mapGenesToSymbols ============================================================
mapGenesToSymbols.Gene2Symbol <-  # nolint
    function(object, genes, strict = TRUE) {
        mapped <- do.call(
            what = .mapGenes,
            args = list(
                object = object,
                genes = genes,
                strict = strict
            )
        )
        return <- object[mapped, , drop = FALSE]
        return <- return[["geneName"]]
        return <- as.character(return)
        names(return) <- names(mapped)
        return
    }



#' @rdname mapGenes
#' @export
setMethod(
    f = "mapGenesToSymbols",
    signature = signature("Gene2Symbol"),
    definition = mapGenesToSymbols.Gene2Symbol
)



mapGenesToSymbols.SummarizedExperiment <-  # nolint
    function(object, genes, strict = TRUE) {
        validObject(object)
        suppressMessages(
            g2s <- Gene2Symbol(object)
        )
        assert_are_identical(rownames(g2s), rownames(object))
        do.call(
            what = mapGenesToSymbols,
            args = list(
                object = g2s,
                genes = genes,
                strict = strict
            )
        )
    }



#' @rdname mapGenes
#' @export
setMethod(
    f = "mapGenesToSymbols",
    signature = signature("SummarizedExperiment"),
    definition = mapGenesToSymbols.SummarizedExperiment
)
