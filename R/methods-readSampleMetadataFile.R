#' Read Sample Metadata File
#'
#' @rdname readSampleMetadataFile
#' @name readSampleMetadataFile
#' @family Data Import and Project Utilities
#'
#' @inheritParams AllGenerics
#' @param object Metadata file. Supports CSV and XLSX file formats.
#' @param pattern *Optional*. Grep pattern to match against sample names.
#' @param patternCol *Optional*. Column in data frame used for pattern
#'   subsetting.
#' @param lanes *Optional*. Number of lanes used to split the samples into
#'   technical replicates (`_LXXX`) suffix.
#'
#' @return [tibble], grouped by `sampleName`.
NULL



# Methods ====
#' @rdname readSampleMetadataFile
#' @export
setMethod("readSampleMetadataFile", "character", function(
    object,
    pattern = NULL,
    patternCol = "sampleName",
    lanes = 1) {
    meta <- readFileByExtension(object)
    # Rename legacy `samplename` column, if set
    if ("samplename" %in% colnames(meta)) {
        meta <- dplyr::rename(meta, fileName = .data[["samplename"]])
    }

    # Rename `description` to `sampleName`, if set
    if ("description" %in% colnames(meta)) {
        meta <- dplyr::rename(meta, sampleName = .data[["description"]])
    }
    meta <- meta %>%
        # Strip all NA rows and columns
        removeNA() %>%
        # Make colnames camelCase
        camel(strict = FALSE) %>%
        # Remove rows with no sample name. Sometimes Excel files will add
        # empty rows, so this helps correct that problem as well.
        .[!is.na(.[["sampleName"]]), , drop = FALSE]

    # Lane split, if desired
    if (lanes > 1) {
        meta <- meta %>%
            group_by(!!sym("sampleName")) %>%
            # Expand by lane (e.g. "L001")
            expand(lane = paste0("L", str_pad(1:lanes, 3, pad = "0"))) %>%
            left_join(meta, by = "sampleName") %>%
            ungroup() %>%
            mutate(sampleName = paste(
                .data[["sampleName"]], .data[["lane"]], sep = "_"))
    }

    # Subset by pattern, if desired
    if (!is.null(pattern)) {
        meta <- meta %>%
            .[str_detect(.[[patternCol]], pattern), , drop = FALSE]
    }

    meta %>%
        # Sanitize `sampleID` into valid names
        mutate(sampleID = make.names(.data[["sampleName"]])) %>%
        .arrangeMetadataByPriorityCols() %>%
        .setMetadataFactors()
})
